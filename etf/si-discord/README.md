# SI Discord maintenance scripts
Oh boy, this is a wild one...

So, our generation of students of Software Engineering at the [School of Electrical Engineering (University of Belgrade)](https://www.etf.bg.ac.rs/) mostly communicated over our Discord server. We needed to associate students (with their year/index number combination) with Discord users (with their user ID), and we already required all server members set their nickname to their real name (we permitted anonymous users to idle in the server, but not to communicate). We also needed several different features which required this association:

- we needed to assign roles based on courses that students were enrolled in, so we could add role gates to course channels,
- we needed to organize rather important polls on decisions regarding certain courses, and to give the polls legitimacy only students that were enrolled to these courses were allowed to vote,
- our WhatsApp-Discord bridge (at the time of writing, located at the [services](https://github.com/KockaAdmiralac/services) repository, but will probably soon be transferred to this one) needed to associate phone numbers with real names, so it could display them instead of a nickname + phone number combination on each message,
- and so on...

For this, I've built a database of student-user associations, along with phone number data for users who joined any WhatsApp groups with a bridge. All data was collected either by me or by other members of the server's administration. (I don't think there was anything illegal in such a data collection process. I mean, do you have to ask somebody before you add them as a phone contact, provided you know their name and are already communicating with them over phone?) The mentioned data, clearly, was never publicized, and the full database remained only at my server. In addition to that, I've had to write a set of scripts to maintain this database and perform operations using its data, most of which are collected here.

## Setup
You can install required packages using `npm install`. Configuration was done through a file named `config.json`, whose sample you can see in this repository. It requires you to create a MySQL database, whose schema you can see in `main.sql`.

## Scripts
Below is the list of scripts involved in the creation, usage and maintenance of the database above, with their input and output information.

### Utility
These scripts are not meant for standalone execution, but rather serve in other scripts as utilities.

- `util.js`: exports utility functions used in several different scripts
    - Command-line arguments: None
    - Required configuration in `config.json`: None
    - Input files: `latinify.json` (for scripts using `latinify` and `cyrillify`, already committed)
    - Output files: None
- `db.js`: exports a class used for interfacing with the database (not all scripts use it, because it was built later during the development)
    - Command-line arguments: None
    - Required configuration in `config.json`: `db`
    - Input files: None
    - Output files: None

### Initial data collection
These scripts were used when initially forming the database. On our Discord server, users were nicknamed with their proper real names which we could use to connect their Discord IDs with index numbers (`discord-connect.js`), and I used one moderator's phone book to import most of the phone number data (`vcf-db.js`), then patched it with later additions (`pn-db.js`).

- `discord-dump.js`: dumps server members with their role information to `discord.json` (probably intended to work with an older version of discord.js than specified in `package.json`)
    - Command-line arguments: None
    - Required configuration in `config.json`: `token`, `server`
    - Input files: None
    - Output files: `discord.json` (server member list)
- `discord-connect.js`: given a list of users in the server, and a list of users with their real names in Serbian Cyrillic script as well as their index numbers, writes members it was able to connect to `discord.txt`, and those it was not to `discord-unconnected.txt`
    - Command-line arguments: None
    - Required configuration in `config.json`: None
    - Input files: `discord.json` (generated by `discord-dump.js`), `indeksi.txt` (list of students in the form of `year;index;surname;name`, each in new row)
    - Output files: `discord.txt` (connected server member list), `discord-unconnected.txt` (unconnected server member list)
- `discord-db.js`: inserts connections made by `discord-connect.js` into the database (I later wrote `import-csv.js`, which should be a better version of this)
    - Command-line arguments: None
    - Required configuration in `config.json`: `db`
    - Input files: `discord.txt` (generated by `discord-connect.js`)
    - Output files: None
- `vcf-db.js`: imports phone numbers from a VCF file into the database (given that students with names equal to those in the VCF file)
    - Command-line arguments: None
    - Required configuration in `config.json`:  `db`
    - Input files: `db.vcf`
    - Output files: None
- `pn-db.js`: same as `vcf-db.js` but does not use a VCF file
    - Command-line arguments: None
    - Required configuration in `config.json`: `db`
    - Input files: `pn.txt` (students whose phone numbers to insert, each row formatted as `phone;name;surname`)
    - Output files: None

### Maintenance
These scripts were used to maintain the data in the database.

- `discord-diff.js`: finds server members with roles but without an associated row in the database
    - Command-line arguments: None
    - Required configuration in `config.json`: `ignoredRoles`, `db`
    - Input files: `discord.json` (generated by `discord-dump.js`)
    - Output files: `discord-diff.txt` (users which are missing from the database)
- `import-csv.js`: generates SQL for importing student data from a CSV file
    - Command-line arguments: None
    - Required configuration in `config.json`: `db`
    - Input files: `import.csv` (data to import, the separator is a semicolon instead of a comma!)
    - Output files: None
- `update-db.sh`: drops the local database, pulls it from a remote server and recreates it with that data. Environment variables that this script requires are:
    - `LOCAL_DB_USER`: MySQL username of the local user that drops and recreates the database
    - `LOCAL_DB_NAME`: Name of the local MySQL database to drop and recreate
    - `REMOTE_DB_HOST`: Address of the remote database server to access via SSH
    - `REMOTE_DB_USER`: MySQL username of the remote user that reads the database
    - `REMOTE_DB_NAME`: Name of the remote MySQL database to read

### Role management
These scripts were used to assign roles based on courses to server members, based on database data and course member lists. Course member lists were initially obtained through [mailing list](https://lists.etf.bg.ac.rs/) member dumps, and then (much later) switched to pulling that data from student services (`subjects.js`).

- `add-roles.js`: assigns roles based on a list of email addresses.
    - Command-line arguments: None
    - Required configuration in `config.json`: `role`, `token`, `server`, `db`
    - Input files: `roles.txt`, each student email in a new line
    - Output files: None
- `roles-convert.js`: converts a Microsoft Stream API response JSON for Stream group members into a role list
    - Command-line arguments: None
    - Required configuration in `config.json`: None
    - Input files: `roles-convert.json` (Microsoft Stream API response JSON for Stream group members)
    - Output files: `roles.txt` (email list for `add-roles.js`)
- `subjects.js`: pulls all courses of all database users from our online student services
    - Command-line arguments: None
    - Required configuration in `config.json`: `username`, `password`, `db`
    - Input files: None
    - Output files: `subjects.json` (a list of course codes for each student in the database)
- `create-roles-list.js`: converts a `subjects.json` file into a list that `add-roles.js` accepts
    - Command-line arguments: course code to form a list from
    - Required configuration in `config.json`: None
    - Input files: `subjects.json` (generated by `subjects.js`)
    - Output files: `roles.txt` (for `add-roles.js`)
- `compare-roles-list.js`: compares two email address lists to see which students are missing from either
    - Command-line arguments: two filenames with email lists
    - Required configuration in `config.json`: `db`
    - Input files: specified as command-line arguments
    - Output files: None

### Voting
As previously mentioned, we had to organize polls on the server for a specific subset of the server's population. These scripts aided us in that.

- `voting.js`: checks whether all users who reacted to a message are on a specific course
    - Command-line arguments: None
    - Required configuration in `config.json`: `server`, `channel`, `message`, `db`, `token`
    - Input files: `voting-roles.txt` (formatted the same way as `roles.txt`, emails of all users on a course)
    - Output files: None
- `names.js`: prints names of users with specified index numbers, or `???` if the user is not in the database
    - Command-line arguments: None
    - Required configuration in `config.json`: `db`
    - Input files: `names.txt` (each row formatted as `year;index`)
    - Output files: None
